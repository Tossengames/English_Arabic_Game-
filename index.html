<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chō-Han: The Great Hall</title>
    <style>
        :root {
            --tatami: #c5ba9a; --wood: #2c1e16; --red: #8b0000;
            --gold: #d4af37; --win: #2e7d32; --lose: #c62828;
        }

        body { background: #000; color: #fff; font-family: 'Segoe UI', sans-serif; margin: 0; overflow: hidden; display: flex; justify-content: center; height: 100vh; }
        
        #game-view { 
            width: 100%; max-width: 500px; height: 100%;
            background: var(--wood); display: flex; flex-direction: column; position: relative; 
        }

        #log-ticker { height: 40px; background: #000; color: var(--gold); display: flex; align-items: center; justify-content: center; font-size: 0.8rem; border-bottom: 2px solid var(--gold); text-transform: uppercase; flex-shrink: 0; }

        /* THE TATAMI */
        #tatami { flex: 1; background: var(--tatami); margin: 5px; border: 8px solid #3d2b1f; position: relative; display: flex; justify-content: center; align-items: center; overflow: hidden; }

        #cup { width: 70px; height: 90px; background: #5d4037; border-radius: 35px 35px 5px 5px; border: 4px solid #3e2723; position: relative; z-index: 10; transition: transform 0.8s; }
        .dice-reveal { position: absolute; display: flex; gap: 15px; z-index: 5; }
        .die { width: 35px; height: 35px; background: #fff; border-radius: 4px; display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); padding: 3px; box-sizing: border-box; }
        .dot { background: #111; border-radius: 50%; width: 5px; height: 5px; align-self: center; justify-self: center; }
        .dot.red { background: #d32f2f; width: 8px; height: 8px; }

        /* SPOTS */
        .player-spot { position: absolute; width: 60px; text-align: center; font-size: 0.65rem; font-weight: bold; transition: all 0.4s; }
        .coin-visual { width: 28px; height: 28px; border-radius: 50%; border: 1px solid #444; background: #222; color: #fff; display: flex; align-items: center; justify-content: center; margin: 0 auto 2px; }

        .spot-0 { top: 2%; left: 42%; } .spot-1 { top: 12%; right: 5%; }
        .spot-2 { top: 45%; right: 2%; } .spot-3 { bottom: 12%; right: 5%; }
        .spot-4 { bottom: 2%; left: 42%; } .spot-5 { bottom: 12%; left: 5%; }
        .spot-6 { top: 45%; left: 2%; } .spot-7 { top: 12%; left: 5%; }

        /* SCROLLABLE UI LAYER */
        #ui-layer { 
            height: 40%; background: rgba(10,10,10,0.98); 
            border-top: 3px solid var(--gold); overflow-y: auto; 
            padding: 10px; box-sizing: border-box;
        }
        
        #setup-ui { display: flex; flex-direction: column; gap: 6px; }
        .setup-item { background: #222; padding: 10px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid transparent; }
        .setup-item input { width: 120px; background: #000; color: #fff; border: 1px solid #555; padding: 5px; font-size: 1rem; }
        
        .start-btn { width: 100%; padding: 18px; background: var(--red); color: white; border: 2px solid var(--gold); font-weight: bold; font-size: 1.2rem; margin-top: 10px; margin-bottom: 20px; }

        .hidden { display: none !important; }
        button { cursor: pointer; border-radius: 4px; }
        .payout-particle { position: absolute; font-weight: bold; font-size: 1.2rem; pointer-events: none; z-index: 20; transition: all 1.2s ease-in-out; }
        .shake-cam { animation: camShake 0.1s infinite; }
        @keyframes camShake { 0%{transform: translate(2px,0)} 50%{transform: translate(-2px,0)} 100%{transform: translate(2px,0)} }
    </style>
</head>
<body>

<div id="game-view">
    <div id="log-ticker">PREPARE FOR BATTLE</div>

    <div id="tatami">
        <div id="cup"></div>
        <div id="dice-reveal" class="dice-reveal hidden"></div>
        <div id="spots-container"></div>
    </div>

    <div id="ui-layer">
        <div id="setup-ui">
            <div id="setup-controls"></div>
            <button class="start-btn" onclick="startGame()">OPEN THE DEN</button>
        </div>

        <div id="betting-ui" class="hidden" style="text-align:center;">
            <h2 id="p-display-name" style="margin:2px 0;"></h2>
            <p id="p-display-money" style="color:var(--gold); margin:2px 0;"></p>
            <div style="margin:10px 0;">
                <button onclick="modBet(-50)" style="padding:10px 15px">-50</button>
                <input type="number" id="bet-amt" value="50" style="width:60px; text-align:center; background:#000; color:#fff; font-size:1.2rem;">
                <button onclick="modBet(50)" style="padding:10px 15px">+50</button>
            </div>
            <div style="display:flex; gap:5px;">
                <button onclick="placeBet('Chō')" style="flex:1; padding:15px; background:var(--red); color:#fff; font-weight:bold;">CHŌ</button>
                <button onclick="placeBet('Han')" style="flex:1; padding:15px; background:var(--red); color:#fff; font-weight:bold;">HAN</button>
                <button onclick="withdraw()" style="padding:15px; background:#333; color:#fff;">LEAVE</button>
            </div>
        </div>

        <div id="results-ui" class="hidden" style="text-align:center;">
            <h1 id="final-result-text" style="margin:5px 0; color:var(--gold);"></h1>
            <div id="action-btns" class="hidden">
                <button onclick="callCheat()" style="background:orange; padding:15px; width:48%; font-weight:bold;">CALL CHEAT</button>
                <button onclick="newRound()" style="background:var(--win); padding:15px; width:48%; font-weight:bold; color:white;">NEXT ROUND</button>
                <button onclick="location.reload()" style="background:#444; width:100%; margin-top:8px; padding:10px; color:white;">EXIT TO MENU</button>
            </div>
        </div>
    </div>
</div>

<script>
    const colors = ['#FF5252', '#FF4081', '#E040FB', '#7C4DFF', '#536DFE', '#448AFF', '#18FFFF', '#64FFDA'];
    const diePatterns = [[], [4], [0, 8], [0, 4, 8], [0, 2, 6, 8], [0, 2, 4, 6, 8], [0, 2, 3, 5, 6, 8]];
    let players = [], bets = [], curIdx = 0, isCheating = false, roundResult = "";

    const setupBox = document.getElementById('setup-controls');
    let config = Array(8).fill(false);

    for(let i=0; i<8; i++) {
        const item = document.createElement('div');
        item.className = 'setup-item';
        item.style.borderLeftColor = colors[i];
        item.innerHTML = `
            <input type="text" id="name-${i}" value="Player ${i+1}">
            <button onclick="toggleType(${i})" id="type-${i}" style="padding:10px 15px; background:#444; color:#fff; border:none; font-weight:bold;">HUMAN</button>
        `;
        setupBox.appendChild(item);
    }

    function toggleType(i) {
        config[i] = !config[i];
        const btn = document.getElementById(`type-${i}`);
        btn.innerText = config[i] ? "CPU" : "HUMAN";
        btn.style.background = config[i] ? "#777" : "#444";
    }

    function ticker(m) { document.getElementById('log-ticker').innerText = m; }

    function startGame() {
        players = config.map((isAI, i) => ({
            name: document.getElementById(`name-${i}`).value,
            money: 1000, isAI: isAI, color: colors[i], active: true
        }));
        
        document.getElementById('spots-container').innerHTML = players.map((p, i) => `
            <div id="spot-${i}" class="player-spot spot-${i}">
                <div class="coin-visual" id="coin-${i}">-</div>
                <div style="color:${p.color}">${p.name}</div>
            </div>
        `).join('');

        document.getElementById('setup-ui').classList.add('hidden');
        newRound();
    }

    function newRound() {
        curIdx = 0; bets = []; isCheating = false;
        document.getElementById('cup').style.transform = "translate(0,0)";
        document.getElementById('dice-reveal').classList.add('hidden');
        document.getElementById('results-ui').classList.add('hidden');
        document.getElementById('action-btns').classList.add('hidden');
        players.forEach((p, i) => {
            const c = document.getElementById(`coin-${i}`);
            c.innerText = "-"; c.style.background = "#222";
            document.getElementById(`spot-${i}`).style.opacity = (p.active && p.money > 0) ? "1" : "0.3";
            document.getElementById(`spot-${i}`).style.transform = "scale(1)";
        });
        nextTurn();
    }

    function nextTurn() {
        if(curIdx < 8) {
            let p = players[curIdx];
            if(!p.active || p.money <= 0) { curIdx++; nextTurn(); return; }
            document.querySelectorAll('.player-spot').forEach(s => s.style.transform = "scale(1)");
            document.getElementById(`spot-${curIdx}`).style.transform = "scale(1.3)";

            if(p.isAI) {
                ticker(p.name + " is thinking...");
                setTimeout(() => {
                    confirmBet(Math.random() > 0.5 ? 'Chō' : 'Han', Math.min(100, p.money));
                }, 800);
            } else {
                ticker("Betting: " + p.name);
                document.getElementById('betting-ui').classList.remove('hidden');
                document.getElementById('p-display-name').innerText = p.name;
                document.getElementById('p-display-name').style.color = p.color;
                document.getElementById('p-display-money').innerText = p.money + " Mon";
                document.getElementById('ui-layer').scrollTop = 0; // Ensure betting UI is at top
            }
        } else {
            document.getElementById('betting-ui').classList.add('hidden');
            reveal();
        }
    }

    function modBet(v) {
        const inp = document.getElementById('bet-amt');
        inp.value = Math.max(10, Math.min(parseInt(inp.value)+v, players[curIdx].money));
    }

    function placeBet(type) { confirmBet(type, parseInt(document.getElementById('bet-amt').value)); }

    function withdraw() {
        players[curIdx].active = false;
        document.getElementById('betting-ui').classList.add('hidden');
        curIdx++; nextTurn();
    }

    function confirmBet(t, a) {
        bets[curIdx] = { type: t, amt: a };
        const c = document.getElementById(`coin-${curIdx}`);
        c.innerText = a;
        c.style.background = (t === 'Chō') ? '#444' : '#888';
        document.getElementById('betting-ui').classList.add('hidden');
        curIdx++;
        setTimeout(nextTurn, 400);
    }

    function drawDie(val, container) {
        const d = document.createElement('div');
        d.className = 'die';
        for(let i=0; i<9; i++) {
            const dot = document.createElement('div');
            dot.className = 'dot';
            if(val === 1 && i === 4) dot.classList.add('red');
            if(!diePatterns[val].includes(i)) dot.style.visibility = 'hidden';
            d.appendChild(dot);
        }
        container.appendChild(d);
    }

    function reveal() {
        document.getElementById('tatami').classList.add('shake-cam');
        ticker("DEALER IS SHAKING...");
        setTimeout(() => {
            document.getElementById('tatami').classList.remove('shake-cam');
            document.getElementById('cup').style.transform = "translateY(-400px)"; 
            const d1 = Math.floor(Math.random()*6)+1, d2 = Math.floor(Math.random()*6)+1;
            if(Math.random() < 0.15) isCheating = true;
            const diceBox = document.getElementById('dice-reveal');
            diceBox.innerHTML = ''; drawDie(d1, diceBox); drawDie(d2, diceBox);
            diceBox.classList.remove('hidden');
            roundResult = ((d1+d2) % 2 === 0) ? 'Chō' : 'Han';
            ticker("RESULT: " + roundResult.toUpperCase());
            setTimeout(animateResults, 1000);
        }, 1200);
    }

    async function animateResults() {
        document.getElementById('results-ui').classList.remove('hidden');
        document.getElementById('final-result-text').innerText = roundResult.toUpperCase();
        for(let i=0; i<8; i++) {
            if(!bets[i] || !players[i].active) continue;
            const won = bets[i].type === roundResult;
            ticker(`${players[i].name}: ${won ? 'WIN' : 'LOSE'}`);
            const p = document.createElement('div');
            p.className = 'payout-particle';
            p.innerText = won ? "+" + bets[i].amt : "-" + bets[i].amt;
            p.style.color = won ? 'var(--win)' : 'var(--lose)';
            p.style.left = '50%'; p.style.top = '50%';
            document.getElementById('tatami').appendChild(p);
            const rect = document.getElementById(`spot-${i}`).getBoundingClientRect();
            const matRect = document.getElementById('tatami').getBoundingClientRect();
            setTimeout(() => {
                p.style.left = (rect.left - matRect.left + 20) + 'px';
                p.style.top = (rect.top - matRect.top + 10) + 'px';
                p.style.opacity = '0';
                document.getElementById(`coin-${i}`).style.background = won ? 'var(--win)' : 'var(--lose)';
                if(won) players[i].money += bets[i].amt; else players[i].money -= bets[i].amt;
            }, 50);
            await new Promise(r => setTimeout(r, 1400));
            p.remove();
        }
        document.getElementById('action-btns').classList.remove('hidden');
    }

    function callCheat() {
        if(isCheating) { ticker("CAUGHT! DEALER PAYS!"); players.forEach((p, i) => { if(bets[i]) p.money += (bets[i].amt * 2); }); }
        else { ticker("FALSE! 50% FINE!"); players.forEach(p => p.money = Math.floor(p.money * 0.5)); }
        document.getElementById('action-btns').classList.add('hidden');
        setTimeout(() => document.getElementById('action-btns').classList.remove('hidden'), 1000);
    }
</script>
</body>
</html>
